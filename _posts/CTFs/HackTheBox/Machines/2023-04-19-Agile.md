---
title: CTFs | HackTheBox | Machines | Agile
author: BatBato
date: 2023-04-19
categories: [CTFs, HackTheBox, Machines]
tags: [CTF, HackTheBox, Machines, Flask, CVE]
permalink: /CTFs/HackTheBox/Machines/Agile
---

# Agile - Machine [Medium]

Hello there. Today, we are going to look at the Agile room. This was my first medium and I took a lot of time on the foothold for some unknown reason :).

## Port Enumeration

We first launch a Nmap on the machine and as we can see we have a redirection to [http://superpass.htb](http://superpass.htb). So we add it to our ```/etc/hosts``` file. 

![image](https://user-images.githubusercontent.com/73934639/233036782-664de8cc-3677-4915-b6bf-7d644fb27a63.png)

## Web Enumeration

When accessing the website for the first time we notice nothing stange. It's just a basic website.

![image](https://user-images.githubusercontent.com/73934639/233037256-099039a1-8b25-40a0-8b9b-c4733072ec91.png)

We try to create an account to see what happen and we then can log in with our newly created user. When doing some action on the website as register, login, export... We may encounter server errors like the following:

![image](https://user-images.githubusercontent.com/73934639/233037680-b2c607fb-553f-450d-9969-d72559768a3f.png)

This allows us to know that this run a Flask app in ```wsgi_app```:

![image](https://user-images.githubusercontent.com/73934639/233037952-340d5c64-b91b-4e8a-8819-75990a0963b6.png)

We notice that there are two main paths. The first one is the Flask path and the other one is the app folder:

![image](https://user-images.githubusercontent.com/73934639/233038395-78068a2e-241e-4b87-aba6-cedd8d95f261.png)

This will come in handy later.

When we connect to the website, we see that it's basically just a password vault. We can add a user and a website and the password will be automatically generated:

![image](https://user-images.githubusercontent.com/73934639/233039432-8586dbe8-b0b7-49cd-b0bb-0faa03c5363a.png)

When we try to export it, a ```.csv``` file is generated. We try to intercept the command in BurpSuite and... We can see that a request is made at ```/download?fn=a_export_bec55b6381.csv``` to download a ```.csv``` file of the format ```USER_export_RANDOMCHAR.csv```

![image](https://user-images.githubusercontent.com/73934639/233040151-1aeb9ce0-47fe-49e1-b035-0cc23d2957dc.png)

Another request is then made to the download page stating that the debugger is up:

![image](https://user-images.githubusercontent.com/73934639/233041048-a8b2a94b-184c-472a-abfa-7483e45f6789.png)

## LFI

We may want to try some basic LFI and access the ```/etc/passwd``` file:

![image](https://user-images.githubusercontent.com/73934639/233041468-27bf845d-effc-4508-be8e-2ede8cd87dbe.png)

And voilÃ , we can download any file we want on the machine:

![image](https://user-images.githubusercontent.com/73934639/233041559-434b1b41-1c14-4807-9c7d-b5f4d196dfaa.png)

Now that we can donwload any file we want, why not downloading the ones from the website to see if we can find any interesting informations. We saw earlier that there were a file that may contain valuable informations in ```/app/app/superpass/app.py``` and we find a debug function:

![image](https://user-images.githubusercontent.com/73934639/233043980-1232d699-1f57-4f8b-a0e9-aff3f6d58b32.png)

## PIN Generator

Looking for ```Flask debuger vulnerabilities``` on internet we find a usefull link from [hacktricks](https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/werkzeug) taling about a console that may allows us to get a RCE, but unfortunately, it is not available at ```/console```. But if we are carefull enought, we can see that there is a small console icon when we are on an error page:

![image](https://user-images.githubusercontent.com/73934639/233046011-cdf4bbb9-49c1-4f28-95f4-eebf3ddb37f1.png)

We can click on it but it will ask us for the PIN, that we don't have...Yet. 
So basically we need to retrieve all this information:

![image](https://user-images.githubusercontent.com/73934639/233046322-b34c7a57-399a-4a8d-b8f9-9ede2fdad4da.png)

The HackTrick article state that we need to find the user running the app, the value returned by ```getattr(app, '__name__', getattr (app .__ class__, '__name__'))``` and the one returned by ```getattr(mod, '__file__', None)``` that is the absolute path of app.py.

We already found the app name ```wsgi_app``` and the the path of the app.py is ```/app/venv/lib/python3.10/site-packages/flask/app.py```. So now we need to find the user running the app.

We find the website [Bangrewell](https://www.bengrewell.com/cracking-flask-werkzeug-console-pin/) that gives us much more information about how the PIN is generated and how to generate it (which is what we want to do :) ).

The article states that we can find the user running the app in the ```/proc/self/environ``` file. And after donwloading it, we find the user ```www-data```:

![image](https://user-images.githubusercontent.com/73934639/233048722-dcc4e552-f3a5-4a04-869e-7d15c89a520a.png)

We can be sure that it is the right user when donwloading the ```/proc/self/status``` file and see the ```UID``` of that user:

![image](https://user-images.githubusercontent.com/73934639/233048939-c56ba876-3a56-4472-9710-43d9206d1f2f.png)

Now we just need to find the ```private_bits``` part. We've seent that the first value is generated with the ```str(uuid.getnode())``` function. This is the MAC address of the machine that is converted as an integer. I first tried with the MAC address in the ```/proc/net/arp``` but it didn't worked. I then tried with the one of the ```eth0``` interface available in the ```/sys/class/net/eth0/address``` file. We then convert it as an INT with python:

![image](https://user-images.githubusercontent.com/73934639/233050395-a4fa9e86-9d13-44ab-a051-be64bfc25418.png)

We now need to recover the second value of the ```private_bits```. Following the [Bengrewell](https://www.bengrewell.com/cracking-flask-werkzeug-console-pin/) steps, we donwload the ```/etc/machine-id``` file and the ```/proc/self/cgroup``` and we recover the machine id and the cgroup value ```superpass.service```.

> /!\ WARNING /!\ The machine id may change! So be sure to recover the new one when you restart your machine. 
{: .prompt-danger}

We can now run our exploit and recover the PIN:

![image](https://user-images.githubusercontent.com/73934639/233052192-fa4b5c88-b90a-46e0-a635-5740271518d4.png)

> The exploit code is available here if you want but I advise you to create it from scratch with the help of the HackTrick and Bengrewell blog in addition with the source code that you downloaded.
{: .prompt-info}

## RCE

Now that we have access to the console, we may want to run command in it.

![image](https://user-images.githubusercontent.com/73934639/233053433-46741d17-cd2c-4742-a421-eaacb33771e6.png)

We try to recover a reverse shell. I used pearl:

![image](https://user-images.githubusercontent.com/73934639/233053839-b39904f2-c296-484f-85b1-12cc5ccbbf08.png)

> You can stabilise your shell with the command ```python3 -c 'import pty;pty.spawn("/bin/bash")';export TERM=xterm``` (here we have python3 not python2). Then press ```CTRL+Z``` and type ```stty raw -echo; fg```. If nothing is printed out press ```ENTER``` and you will get a full shell with autocompletion.
{: .prompt-tip}

## Horizontal PrivEsc


## Vertical PrivEsc

